<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>ניהול גבייה</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="p-4">
    <h1 class="mb-4">מערכת ניהול גבייה</h1>

    <div class="card p-3 mb-4">
        <h5>הוספת לקוח</h5>
        <input id="clientName" class="form-control mb-2" placeholder="שם מלא">
        <input id="clientPhone" class="form-control mb-2" placeholder="טלפון">
        <input id="clientEmail" class="form-control mb-2" placeholder="אימייל">
        <button onclick="addClient()" class="btn btn-primary">הוסף לקוח</button>
    </div>

    <div class="card p-3 mb-4">
        <h5>הוספת חשבונית</h5>
        <input id="invoiceClientId" class="form-control mb-2" placeholder="מזהה לקוח">
        <input id="invoiceAmount" class="form-control mb-2" placeholder="סכום">
        <input id="invoiceDescription" class="form-control mb-2" placeholder="תיאור">
        <button onclick="addInvoice()" class="btn btn-secondary">הוסף חשבונית</button>
    </div>

    <div class="card p-3 mb-4">
        <h5>הוספת תשלום</h5>
        <input id="paymentInvoiceId" class="form-control mb-2" placeholder="מזהה חשבונית">
        <input id="paymentAmount" class="form-control mb-2" placeholder="סכום ששולם">
        <button onclick="addPayment()" class="btn btn-success">הוסף תשלום</button>
    </div>

    <div class="card p-3 mb-4">
        <h5>חיפוש לקוח</h5>
        <input id="searchClientId" class="form-control mb-2" placeholder="מזהה לקוח">
        <button onclick="getClientReport()" class="btn btn-info">הצג דוח</button>
    </div>

    <div class="card p-3 mb-4" id="reportCard" style="display:none">
        <h5>דו"ח לקוח</h5>
        <div id="clientReport"></div>
        <button onclick="downloadPDF()" class="btn btn-danger mt-2">הורד PDF</button>
        <button onclick="downloadExcel()" class="btn btn-warning mt-2">הורד Excel</button>
    </div>

    <script>
        const apiBase = "http://74.234.81.15:8080/ClientPaymentApi/api/";

        async function addClient() {
            const body = {
                fullName: document.getElementById("clientName").value,
                phoneNumber: document.getElementById("clientPhone").value,
                email: document.getElementById("clientEmail").value
            };
            await fetch(apiBase + "clients", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            }).then(r => r.ok ? alert("נוסף בהצלחה") : alert("שגיאה"));
        }

        async function addInvoice() {
            const body = {
                clientID: parseInt(document.getElementById("invoiceClientId").value),
                amount: parseFloat(document.getElementById("invoiceAmount").value),
                description: document.getElementById("invoiceDescription").value
            };
            await fetch(apiBase + "invoices", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            }).then(r => r.ok ? alert("חשבונית נוספה") : alert("שגיאה"));
        }

        async function addPayment() {
            const body = {
                invoiceID: parseInt(document.getElementById("paymentInvoiceId").value),
                amountPaid: parseFloat(document.getElementById("paymentAmount").value)
            };
            await fetch(apiBase + "payments", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            }).then(r => r.ok ? alert("תשלום נוסף") : alert("שגיאה"));
        }

        async function getClientReport() {
            const id = document.getElementById("searchClientId").value;
            const res = await fetch(apiBase + "clients/" + id);
            const data = await res.json();
            if (!data || data.invoices === undefined) {
                alert("לקוח לא נמצא");
                return;
            }

            let html = `<h6>${data.fullName}</h6><ul>`;
            data.invoices.forEach(inv => {
                html += `<li>
                    ${inv.description || ''} | ${inv.amount} ש"ח | שולם: ${inv.totalPaid || 0} | יתרה: ${inv.balance}
                </li>`;
            });
            html += "</ul>";
            document.getElementById("clientReport").innerHTML = html;
            document.getElementById("reportCard").style.display = "block";
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(document.getElementById("clientReport").innerText, 10, 10);
            doc.save("report.pdf");
        }

        function downloadExcel() {
            const reportText = document.getElementById("clientReport").innerText;
            const rows = reportText.split("\n").map(line => [line]);
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, "report.xlsx");
        }
    </script>
</body>
</html>
